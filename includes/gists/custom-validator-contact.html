

<pre><code class="language-csharp">public class CreateContactValidator : AbstractValidator&lt;CreateContact&gt;
{
    public CreateContactValidator()
    {
        RuleFor(r =&gt; r.Title).NotEqual(Title.Unspecified).WithMessage(&quot;Please choose a title&quot;);
        RuleFor(r =&gt; r.Name).NotEmpty();
        RuleFor(r =&gt; r.Color).Must(x =&gt; x.IsValidColor()).WithMessage(&quot;Must be a valid color&quot;);
        RuleFor(r =&gt; r.FilmGenres).NotEmpty().WithMessage(&quot;Please select at least 1 genre&quot;);
        RuleFor(r =&gt; r.Age).GreaterThan(13).WithMessage(&quot;Contacts must be older than 13&quot;);
        RuleFor(x =&gt; x.Agree).Equal(true).WithMessage(&quot;You must agree before submitting&quot;);
    }
}

[Authenticate] // Limit to Authenticated Users
[ErrorView(nameof(CreateContact.ErrorView))] // Display ErrorView for HTML requests resulting in an Exception
[DefaultView(&quot;/server/contacts&quot;)] // Render custom HTML View for HTML Requests
public class ContactServices : Service
{
    private static int Counter = 0;
    internal static readonly ConcurrentDictionary&lt;int, Data.Contact&gt; Contacts = new ConcurrentDictionary&lt;int, Data.Contact&gt;();

    public object Any(GetContacts request)
    {
        var userId = this.GetUserId();
        return new GetContactsResponse
        {
            Results = Contacts.Values
                .Where(x =&gt; x.UserAuthId == userId)
                .OrderByDescending(x =&gt; x.Id)
                .Map(x =&gt; x.ConvertTo&lt;Contact&gt;())
        };
    }

    public object Any(GetContact request) =&gt;
        Contacts.TryGetValue(request.Id, out var contact) &amp;&amp; contact.UserAuthId == this.GetUserId()
            ? (object)new GetContactResponse { Result = contact.ConvertTo&lt;Contact&gt;() }
            : HttpError.NotFound($&quot;Contact was not found&quot;);

    public object Any(CreateContact request) 
    {
        var newContact = request.ConvertTo&lt;Data.Contact&gt;();
        newContact.Id = Interlocked.Increment(ref Counter);
        newContact.UserAuthId = this.GetUserId();
        newContact.CreatedDate = newContact.ModifiedDate = DateTime.UtcNow;

        var contacts = Contacts.Values.ToList();
        var alreadyExists = contacts.Any(x =&gt; x.UserAuthId == newContact.UserAuthId &amp;&amp; x.Name == request.Name);
        if (alreadyExists)
            throw new ArgumentException($&quot;You already have a contact named '{request.Name}'&quot;, nameof(request.Name));
        
        Contacts[newContact.Id] = newContact;
        return new CreateContactResponse { Result = newContact.ConvertTo&lt;Contact&gt;() };
    }
    
    public object AnyHtml(CreateContact request) // Called for CreateContact API HTML Requests on any HTTP Method
    {
        Any(request);
        return HttpResult.Redirect(request.Continue ?? Request.GetView());
    }

    public void Any(DeleteContact request)
    {
        if (Contacts.TryGetValue(request.Id, out var contact) &amp;&amp; contact.UserAuthId == this.GetUserId())
            Contacts.TryRemove(request.Id, out _);
    }

    public object PostHtml(DeleteContact request) // Only called by DeleteContact HTML POST requests 
    {
        Any(request);
        return HttpResult.Redirect(request.Continue ?? Request.GetView()); //added by [DefaultView]
    }
}

public class UpdateContactValidator : AbstractValidator&lt;UpdateContact&gt;
{
    public UpdateContactValidator()
    {
        RuleFor(r =&gt; r.Id).GreaterThan(0);
        RuleFor(r =&gt; r.Title).NotEqual(Title.Unspecified).WithMessage(&quot;Please choose a title&quot;);
        RuleFor(r =&gt; r.Name).NotEmpty();
        RuleFor(r =&gt; r.Color).Must(x =&gt; x.IsValidColor()).WithMessage(&quot;Must be a valid color&quot;);
        RuleFor(r =&gt; r.FilmGenres).NotEmpty().WithMessage(&quot;Please select at least 1 genre&quot;);
        RuleFor(r =&gt; r.Age).GreaterThan(13).WithMessage(&quot;Contacts must be older than 13&quot;);
    }
}

[ErrorView(nameof(UpdateContact.ErrorView))] // Display ErrorView for HTML requests resulting in an Exception
public class UpdateContactServices : Service
{
    public object Any(UpdateContact request)
    {
        if (!ContactServices.Contacts.TryGetValue(request.Id, out var contact) || contact.UserAuthId != this.GetUserId())
            throw HttpError.NotFound(&quot;Contact was not found&quot;);

        contact.PopulateWith(request);
        contact.ModifiedDate = DateTime.UtcNow;
        
        return request.Continue != null 
            ? (object) HttpResult.Redirect(request.Continue)
            : new UpdateContactResponse();
    }
}

public static class ContactServiceExtensions // DRY reusable logic used in Services and Validators
{
    public static int GetUserId(this Service service) =&gt; int.Parse(service.GetSession().UserAuthId);

    public static bool IsValidColor(this string color) =&gt; !string.IsNullOrEmpty(color) &amp;&amp; 
        (color.FirstCharEquals('#')
            ? int.TryParse(color.Substring(1), NumberStyles.HexNumber, CultureInfo.InvariantCulture, out _)
            : Color.FromName(color).IsKnownColor);
}

// Register Custom Auto Mapping for converting Contact Data Model to Contact DTO
public class ContactsHostConfig : IConfigureAppHost 
{
    public void Configure(IAppHost appHost) =&gt;
        AutoMapping.RegisterConverter((Data.Contact from) =&gt; from.ConvertTo&lt;Contact&gt;(skipConverters:true));
}
</code></pre>
